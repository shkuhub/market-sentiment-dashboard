<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>VIX Dashboard (Stable)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 20px; width: 360px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .row { margin-top: 10px; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
    .label { color: #555; }
    .value { font-weight: bold; font-size: 15px; }
    .positive { color: #d32f2f; }
    .negative { color: #1976d2; }
    .source { font-size: 11px; color: #999; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; text-align: right; }
    
    /* 로딩 중 깜빡이는 효과 */
    @keyframes blink { 50% { opacity: 0.5; } }
    .loading { color: #888; animation: blink 1.5s infinite; font-weight: normal; font-size: 13px; }
  </style>
</head>
<body>

<div class="card">
  <h3 style="margin-top:0; margin-bottom:15px;">VIX (CBOE Volatility Index)</h3>

  <div class="row">
    <span class="label">현재값:</span>
    <span id="vix-current" class="value loading">데이터 가져오는 중...</span>
  </div>
  <div class="row">
    <span class="label">전일 종가:</span>
    <span id="vix-prev" class="value">—</span>
  </div>
  <div class="row">
    <span class="label">금일 변동:</span>
    <span id="vix-change" class="value">—</span>
  </div>
  <div class="row">
    <span class="label">52주 범위:</span>
    <span id="vix-52w" class="value">—</span>
  </div>

  <div class="source">
    Data: Yahoo Finance (Stable Proxy)
  </div>
</div>

<script>
async function fetchVIX_Stable() {
  const symbol = "^VIX";
  // 1년치 데이터 (range=1y)
  const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1y`;
  
  // [수정됨] 가장 안정적인 우회 서버 사용 (속도는 보통, 안정성 최우선)
  // 타임스탬프를 추가하여 캐시 문제 방지
  const proxyUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(yahooUrl) + "&t=" + new Date().getTime();

  try {
    const res = await fetch(proxyUrl);
    if (!res.ok) throw new Error("서버 응답 오류");
    
    const json = await res.json();
    
    // 데이터 구조 검증
    if (!json.chart || !json.chart.result || json.chart.result.length === 0) {
      throw new Error("데이터 형식 오류");
    }

    const result = json.chart.result[0];
    const quotes = result.indicators.quote[0];
    const closes = quotes.close.filter(val => val !== null); // null 값 제거
    
    const currentPrice = result.meta.regularMarketPrice;
    const prevClose = result.meta.chartPreviousClose;
    
    // 변동 계산
    const change = currentPrice - prevClose;
    const changePct = (change / prevClose) * 100;

    // 52주 범위 계산
    const low52w = Math.min(...closes);
    const high52w = Math.max(...closes);

    return {
      current: currentPrice,
      prevClose: prevClose,
      change: change,
      changePct: changePct,
      low52w: low52w,
      high52w: high52w
    };

  } catch (error) {
    console.error("VIX 로드 실패:", error);
    return null;
  }
}

// 실행
fetchVIX_Stable().then(vix => {
  const currentEl = document.getElementById("vix-current");
  
  if (!vix) {
    currentEl.textContent = "불러오기 실패";
    currentEl.style.color = "red";
    currentEl.classList.remove("loading");
    return;
  }

  currentEl.classList.remove("loading");
  
  // 데이터 표시
  currentEl.textContent = vix.current.toFixed(2);
  document.getElementById("vix-prev").textContent = vix.prevClose.toFixed(2);
  
  const changeEl = document.getElementById("vix-change");
  const sign = vix.change >= 0 ? "+" : "";
  changeEl.textContent = `${sign}${vix.change.toFixed(2)} (${sign}${vix.changePct.toFixed(2)}%)`;
  
  // 색상 처리
  changeEl.className = "value " + (vix.change >= 0 ? "positive" : "negative");

  document.getElementById("vix-52w").textContent = 
    `${vix.low52w.toFixed(2)} ~ ${vix.high52w.toFixed(2)}`;
});
</script>

</body>
</html>
